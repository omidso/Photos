function GalleriaDataFromJSON(a){var e=0,t=[];return $.each(a,function(){var a=this,i="<div> Focal Length: "+a.focallength+" mm f/"+a.fstop+"<br>"+"Exposure: "+a.exposure+"s"+"<br>"+"ISO: "+a.iso+"<br>"+"Flash: "+a.flash+"<br>"+"Camera make: "+a.make+"<br>"+"Camera model: "+a.model+"<br></div>";t[e++]={thumb:a.thumburl,image:a.url,big:a.bigurl,title:a.name,description:i,photoid:a.id,albumid:a.album_id}}),t}function GalleriaManageFaces(){$(".galleria-info-faces").click(function(){if("true"==$(this).attr("data-active"))$(this).css("background-color","#000000"),$(this).attr("data-active",!1),$(".facebox").remove();else{$(this).css("background-color","#4b698c"),$(this).attr("data-active",!0);var a=Galleria.get(0),e=a.getData().albumid+":"+a.getData().photoid;$.getJSON("/photo/people.json",{q:e},function(e){if(e.people.length){var t=0;$.each(e.people,function(){var i,r,o,n,l=a.getActiveImage().height,h=a.getActiveImage().width,c=a.getActiveImage().x,s=a.getActiveImage().y;e.orientation<=1||3==e.orientation?(n=h/e.width,o=l/e.height,fw=e.faces[t].width*n,fh=e.faces[t].height*o,e.orientation<=1?(i=parseInt(s+e.faces[t].yloc*n),r=parseInt(c+e.faces[t].xloc*o)):(i=ParseInt(s+(l-(fh+e.faces[t].yloc*o))),r=ParseInt(c+(h-(fw+e.faces[t].xloc*n))))):(2==e.orientation||4==e.orientation)&&(n=h/e.height,o=l/e.width,fw=e.faces[t].height*n,fh=e.faces[t].width*o,2==e.orientation?(i=parseInt(s+e.faces[t].xloc*o),r=parseInt(c+(h-(fw+e.faces[t].yloc*n)))):(i=parseInt(s+(l-(fh+e.faces[t].xloc*o))),r=parseInt(c+e.faces[t].yloc*n)));var d='<a href="/people/'+this.id+'/photos ">'+this.name+"</a>",f='<div class="facebox" style= "width: '+fw+"px; height: "+fh+"px;"+"top: "+i+"px;"+"left: "+r+'px;"'+'><span class= "label" style="position: relative; top:-20px">'+d+"</span></div>";$(".page-container").append(f),t++})}})}})}function processPage(a){lastWidth=$("#rowholder").innerWidth()-9,$(".picrow").width(lastWidth),$(".picrow").children().remove(),processAlbums(a)}function processAlbums(a){var e=$(".picrow"),t=e.eq(0).innerWidth(),i=220,r=5,o=[];$.each(a,function(a,e){var t=e.width,r=e.height;r!=i&&(t=Math.floor(t*(i/r))),o.push(t)});for(var n=0,l=0,h=o.length;h>0;){l==e.length&&($("#rowholder").append('<div class="picrow"></div>'),$(".picrow").width(t-9),e=$(".picrow"));var c=e.eq(l++);c.children().remove();for(var s=0,d=0;t>s&&h;)s+=o[n+d++]+2*r,h--;var f=1,p=220;h>0&&(f=t/s,p=Math.min(i,Math.floor(i*f)));var g=0;for(s=0;d>g;){var u=a[n+g],m=Math.floor(o[n+g]*f);!function(){var a='<div class="picimage"'+u.data+' style="height:'+p+"px;width:"+m+"px;margin:"+r+"px;background-image:url("+u.imageurl+')"></div>',e=$(a),t=u.linkurl;e.click(function(){location.href=t}),c.append(e),e.append(u.info)}(),s+=m+2*r,g++}for(g=0;t>s&&h>0;){var v=c.find(".picimage:nth-child("+(g+1)+")");v.width(v.width()+1),g=(g+1)%d,s++}for(g=0;s>t-9;){var w=c.find(".picimage:nth-child("+(g+1)+")");w.width(w.width()-1),g=(g+1)%d,s--}c.height(p+2*r),c.show(),n+=d}for(;l<e.length;)e.eq(l++).hide()}var lastWidth=0;$(function(){if(page=$(".this-page").attr("data-type"),"all albums"==page){var a=[];$.getJSON("/albums.json",function(e){$.each(e,function(){var e=this;a.push({imageurl:e.url,width:e.urlwidth,height:e.urlheight,info:'<div class="picinfo">'+e.name+"<br>"+e.albumdatestr+"</div>",linkurl:"/albums/"+e.id,data:" data-name="+e.onlinename+" data-authkey="+e.authkey})}),processPage(a)}),$(window).resize(function(){var e=$("#rowholder").innerWidth();(lastWidth>e||e>lastWidth)&&processPage(a)})}else{var e=$("#galleria").attr("data-id");$.getJSON("/album/photos.json",{id:e},function(a){a.length&&(picData=GalleriaDataFromJSON(a),Galleria.configure({trueFullscreen:!1,lightbox:!0}),Galleria.run("#galleria",{dataSource:picData}),Galleria.ready(function(){GalleriaManageFaces()}))})}});